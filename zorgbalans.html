<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZorgBalans Prototype</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script> 
    
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/dist/date-fns.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/locale/nl/index.js"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>

    <style>
        input:focus, select:focus { outline: 2px solid #0d9488; }
        body { background-color: #f8fafc; }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        // --- 1. CONFIGURATIE & SETUP ---
        const { useState, useEffect, useMemo } = React;
        const { format, startOfYear, endOfMonth, eachMonthOfInterval, eachDayOfInterval, startOfMonth, isWeekend, addMonths, subMonths, isSameDay } = dateFns;
        const { nl } = dateFns.locale;
        
        // Recharts veilige import
        const { LineChart, Line, ResponsiveContainer, YAxis } = Recharts;

        // --- 2. LOGICA FUNCTIES ---

        const isDutchHoliday = (date) => {
            const dateString = format(date, 'MM-dd');
            // Feestdagen en weekenden markeren
            const fixedHolidays = ['01-01', '04-27', '05-05', '12-25', '12-26'];
            return fixedHolidays.includes(dateString) || isWeekend(date);
        };

        const calculateBalances = (entries, corrections, settings, currentViewDate) => {
            const { monthlyContract, startBalance } = settings;
            const monthsData = [];
            let runningBalance = startBalance;

            const yearStart = startOfYear(currentViewDate);
            const yearEnd = endOfMonth(currentViewDate);
            
            const months = eachMonthOfInterval({ start: yearStart, end: yearEnd });

            months.forEach(monthDate => {
                const monthKey = format(monthDate, 'yyyy-MM');
                
                const totalWorked = Object.entries(entries)
                    .filter(([date]) => date.startsWith(monthKey))
                    .reduce((sum, [_, data]) => sum + (parseFloat(data.hours) || 0), 0);

                const correction = parseFloat(corrections[monthKey] || 0);
                const monthlyResult = totalWorked - monthlyContract + correction;
                
                runningBalance += monthlyResult;

                monthsData.push({
                    month: format(monthDate, 'MMM', { locale: nl }),
                    fullDate: monthKey,
                    cumulative: runningBalance
                });
            });

            const currentMonthKey = format(currentViewDate, 'yyyy-MM');
            const currentTotalWorked = Object.entries(entries)
                .filter(([date]) => date.startsWith(currentMonthKey))
                .reduce((sum, [_, data]) => sum + (parseFloat(data.hours) || 0), 0);

            return {
                currentTotal: runningBalance,
                trendData: monthsData,
                currentMonthWorked: currentTotalWorked
            };
        };

        // --- 3. COMPONENTEN ---

        const Cockpit = ({ stats }) => {
            const isPositive = stats.currentTotal >= 0;
            return (
                <div className="bg-white p-6 rounded-3xl shadow-sm mb-6 border border-slate-100">
                    <div className="flex justify-between items-start">
                        <div>
                            <h2 className="text-slate-400 text-xs font-bold uppercase tracking-wider">Huidige JUS Balans</h2>
                            <div className={`text-4xl font-bold mt-1 flex items-center ${isPositive ? 'text-teal-600' : 'text-rose-500'}`}>
                                {isPositive ? '▲' : '▼'} {stats.currentTotal?.toFixed(2)} u
                            </div>
                        </div>
                        <div className="text-right">
                           <span className="text-xs text-slate-400 block">Prognose</span>
                           <span className="font-semibold text-slate-600">
                             {stats.trendData[stats.trendData.length - 1]?.cumulative.toFixed(0)} u
                           </span>
                        </div>
                    </div>
                    <div className="h-16 mt-4">
                        <ResponsiveContainer width="100%" height="100%">
                            <LineChart data={stats.trendData}>
                                <YAxis hide domain={['dataMin', 'dataMax']} />
                                <Line type="monotone" dataKey="cumulative" stroke={isPositive ? "#0d9488" : "#f43f5e"} strokeWidth={3} dot={false} />
                            </LineChart>
                        </ResponsiveContainer>
                    </div>
                </div>
            );
        };

        const MonthGrid = ({ currentDate, entries, onUpdateEntry }) => {
            const days = eachDayOfInterval({
                start: startOfMonth(currentDate),
                end: endOfMonth(currentDate)
            });

            return (
                <div className="bg-white rounded-xl shadow-sm border border-slate-100 overflow-hidden">
                    {days.map((day) => {
                        const dateStr = format(day, 'yyyy-MM-dd');
                        const entry = entries[dateStr] || { hours: '', type: '' };
                        const isOff = isDutchHoliday(day);
                        
                        return (
                            <div key={dateStr} className={`flex items-center p-3 border-b border-slate-50 last:border-0 ${isOff ? 'bg-slate-50/50' : ''}`}>
                                <div className="w-14 flex-shrink-0 text-center">
                                    <div className={`text-xs font-bold uppercase ${isOff ? 'text-rose-400' : 'text-slate-400'}`}>
                                        {format(day, 'EEE', { locale: nl })}
                                    </div>
                                    <div className="text-lg font-medium text-slate-700">
                                        {format(day, 'dd')}
                                    </div>
                                </div>
                                <div className="flex-1 px-3">
                                    <input
                                        type="number"
                                        placeholder="-"
                                        value={entry.hours}
                                        onChange={(e) => onUpdateEntry(dateStr, 'hours', e.target.value)}
                                        className="w-full bg-slate-100 rounded-lg p-3 text-lg font-semibold text-slate-800 placeholder-slate-300 border-none"
                                    />
                                </div>
                                <div className="w-24">
                                   <select 
                                     value={entry.type}
                                     onChange={(e) => onUpdateEntry(dateStr, 'type', e.target.value)}
                                     className="w-full text-xs bg-transparent text-slate-500 font-medium p-1 border-none"
                                   >
                                     <option value="">Type...</option>
                                     <option value="dag">Dag</option>
                                     <option value="avond">Avond</option>
                                     <option value="nacht">Nacht</option>
                                     <option value="cursus">Cursus</option>
                                     <option value="ziek">Ziek</option>
                                   </select>
                                </div>
                            </div>
                        );
                    })}
                </div>
            );
        };

        // --- 4. DE APP ---
        function App() {
            const [data, setData] = useState(() => {
                const saved = localStorage.getItem('zorgbalans_v2');
                return saved ? JSON.parse(saved) : { 
                    entries: {}, 
                    corrections: {}, 
                    settings: { monthlyContract: 86.66, startBalance: 0 } 
                };
            });

            const [viewDate, setViewDate] = useState(new Date());
            const [showSettings, setShowSettings] = useState(false);

            useEffect(() => {
                localStorage.setItem('zorgbalans_v2', JSON.stringify(data));
            }, [data]);

            const updateEntry = (dateStr, field, value) => {
                setData(prev => ({
                    ...prev,
                    entries: { ...prev.entries, [dateStr]: { ...prev.entries[dateStr], [field]: value } }
                }));
            };

            const updateCorrection = (monthStr, value) => {
                setData(prev => ({ ...prev, corrections: { ...prev.corrections, [monthStr]: value } }));
            };

            const updateSettings = (newSettings) => {
                setData(prev => ({ ...prev, settings: { ...prev.settings, ...newSettings } }));
            };

            const stats = useMemo(() => 
                calculateBalances(data.entries, data.corrections, data.settings, viewDate), 
            [data, viewDate]);

            const currentMonthKey = format(viewDate, 'yyyy-MM');

            return (
                <div className="max-w-md mx-auto min-h-screen bg-slate-50">
                    <header className="bg-teal-700 text-white p-4 pb-12 rounded-b-[2.5rem] shadow-lg sticky top-0 z-10">
                        <div className="flex justify-between items-center mb-4">
                            <h1 className="text-xl font-bold tracking-tight">ZorgBalans</h1>
                            <button onClick={() => setShowSettings(!showSettings)} className="p-2 bg-teal-600 rounded-full text-sm">
                                ⚙️
                            </button>
                        </div>
                        
                        <div className="flex items-center justify-between px-4">
                            <button onClick={() => setViewDate(subMonths(viewDate, 1))} className="text-2xl font-bold p-2">‹</button>
                            <h2 className="text-lg font-medium capitalize">
                                {format(viewDate, 'MMMM yyyy', { locale: nl })}
                            </h2>
                            <button onClick={() => setViewDate(addMonths(viewDate, 1))} className="text-2xl font-bold p-2">›</button>
                        </div>
                    </header>

                    <main className="px-4 -mt-8 relative z-20">
                        {showSettings && (
                            <div className="bg-white p-4 rounded-xl shadow-md mb-6 border-l-4 border-teal-500">
                                <h3 className="font-bold text-slate-700 mb-3">Instellingen</h3>
                                <label className="block text-sm text-slate-500 mb-1">Contracturen per maand</label>
                                <input 
                                    type="number" 
                                    value={data.settings.monthlyContract} 
                                    onChange={(e) => updateSettings({ monthlyContract: parseFloat(e.target.value) })}
                                    className="w-full bg-slate-100 p-2 rounded mb-3"
                                />
                                <label className="block text-sm text-slate-500 mb-1">Startbalans (JUS start)</label>
                                <input 
                                    type="number" 
                                    value={data.settings.startBalance}
                                    onChange={(e) => updateSettings({ startBalance: parseFloat(e.target.value) })}
                                    className="w-full bg-slate-100 p-2 rounded"
                                />
                            </div>
                        )}

                        <Cockpit stats={stats} />

                        <div className="flex justify-between items-center text-sm mb-2 px-2 text-slate-500">
                            <span>Gewerkt: <b className="text-slate-700">{stats.currentMonthWorked?.toFixed(2) || 0}</b></span>
                            <span>Norm: {data.settings.monthlyContract}</span>
                        </div>

                        <MonthGrid currentDate={viewDate} entries={data.entries} onUpdateEntry={updateEntry} />

                        <div className="mt-6 bg-white p-4 rounded-xl border border-slate-100 mb-10">
                            <label className="text-xs font-bold text-slate-400 uppercase">Correctie {format(viewDate, 'MMM', { locale: nl })}</label>
                            <div className="flex gap-2 mt-2">
                                <input 
                                    type="number" 
                                    placeholder="0.00"
                                    value={data.corrections[currentMonthKey] || ''}
                                    onChange={(e) => updateCorrection(currentMonthKey, e.target.value)}
                                    className="flex-1 bg-slate-50 p-2 rounded border border-slate-200"
                                />
                                <div className="flex items-center text-sm text-slate-400">uur</div>
                            </div>
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>